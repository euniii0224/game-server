<!DOCTYPE html>
<html>
  <head>
    <title>ì‚¼ëª© ì„œë²„ í…ŒìŠ¤íŠ¸ (3ì¼ì°¨)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
      .board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        margin-top: 20px;
      }
      .cell {
        width: 100px;
        height: 100px;
        border: 1px solid black;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 60px;
        font-weight: bold;
        cursor: pointer;
      }

      .X {
        color: #007bff;
      }
      .O {
        color: #dc3545;
      }
    </style>
  </head>
  <body>
    <h1>ì‚¼ëª© ì‹¤ì‹œê°„ ê²Œì„</h1>
    <p>ë¸Œë¼ìš°ì € 2ê°œë¥¼ ì—´ì–´ ì ‘ì†í•˜ê³  X ë˜ëŠ” Oë¥¼ ë°°ì •ë°›ìœ¼ì„¸ìš”.</p>
    <div id="status" style="color: blue; font-weight: bold">ì—°ê²° ì¤‘...</div>
    <div class="board">
      <div class="cell" data-id="1"></div>
      <div class="cell" data-id="2"></div>
      <div class="cell" data-id="3"></div>
      <div class="cell" data-id="4"></div>
      <div class="cell" data-id="5"></div>
      <div class="cell" data-id="6"></div>
      <div class="cell" data-id="7"></div>
      <div class="cell" data-id="8"></div>
      <div class="cell" data-id="9"></div>
    </div>
    <script>
      const socket = io()
      const statusDiv = document.getElementById('status')
      const cells = document.querySelectorAll('.cell')

      let playerMark = '' // ë‚˜ì˜ ë§ˆí¬ ('X' ë˜ëŠ” 'O')
      let myTurn = false
      let gameActive = false

      // ë§ˆí¬ë¥¼ í¬í•¨í•œ ê¸°ë³¸ ìƒíƒœ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
      function getStatusMessage(baseMessage) {
        if (playerMark) {
          return baseMessage + ` (ë‹¹ì‹ ì€ ${playerMark}íŒ€)`
        }
        return baseMessage
      }

      // ì„œë²„ ì—°ê²° ì„±ê³µ
      socket.on('connect', function () {
        statusDiv.innerHTML = 'ğŸŸ¢ ì„œë²„ ì—°ê²° ì™„ë£Œ. ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...'
      })

      // ì„œë²„ë¡œë¶€í„° ì¼ë°˜ ë©”ì‹œì§€ ìˆ˜ì‹  (ë””ë²„ê¹… ë° ì•Œë¦¼ìš©)
      socket.on('message', function (msg) {
        statusDiv.innerHTML += `<br>ğŸ’¬ ${msg.data}`
      })

      // ê²Œì„ ì‹œì‘ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
      socket.on('game_start', function (data) {
        // ë³´ë“œ ì´ˆê¸°í™” ë° ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        cells.forEach((cell) => {
          cell.innerHTML = ''
          cell.classList.remove('X', 'O')
        })

        playerMark = data.mark // ë‚´ ë§ˆí¬ ì„¤ì •
        gameActive = true

        statusDiv.innerHTML = `ê²Œì„ ì‹œì‘! ë‹¹ì‹ ì€ **${playerMark}**ì…ë‹ˆë‹¤.`

        // í„´ í™•ì¸
        if (data.turn === socket.id) {
          myTurn = true
          statusDiv.innerHTML = getStatusMessage('â–¶ï¸ **ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤!**')
        } else {
          myTurn = false
          statusDiv.innerHTML = getStatusMessage('ìƒëŒ€ë°©ì˜ í„´ì…ë‹ˆë‹¤...')
        }
      })

      // ì…€ í´ë¦­ ì´ë²¤íŠ¸: í„´ê³¼ ìƒíƒœ ì²´í¬ í›„ ì„œë²„ë¡œ ì „ì†¡
      cells.forEach((cell) => {
        cell.addEventListener('click', function () {
          if (!gameActive || !myTurn) {
            return
          }
          if (this.innerHTML) {
            return
          }

          const cellId = this.getAttribute('data-id')
          socket.emit('place_piece', { id: cellId })
        })
      })

      // ì„œë²„ë¡œë¶€í„° ë³´ë“œ ì—…ë°ì´íŠ¸ ì •ë³´ë¥¼ ë°›ì•˜ì„ ë•Œ
      socket.on('board_update', function (data) {
        const cell = document.querySelector(`.cell[data-id="${data.id}"]`)

        // ë§ˆí¬ í‘œì‹œ ë° ìŠ¤íƒ€ì¼ ì ìš©
        if (cell && !cell.innerHTML) {
          cell.innerHTML = data.mark
          cell.classList.add(data.mark)
        }

        // í„´ ì—…ë°ì´íŠ¸
        if (data.next_turn === socket.id) {
          myTurn = true
          statusDiv.innerHTML = getStatusMessage('âœ… **ë‹¹ì‹ ì˜ í„´ì…ë‹ˆë‹¤!**')
        } else {
          myTurn = false
          statusDiv.innerHTML = getStatusMessage('ìƒëŒ€ë°©ì˜ í„´ì…ë‹ˆë‹¤...')
        }
      })

      // ê²Œì„ ì¢…ë£Œ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
      socket.on('game_end', function (data) {
        gameActive = false
        myTurn = false

        let message = ''

        if (data.winner === 'DRAW') {
          message = getStatusMessage('ğŸ **ê²Œì„ ì¢…ë£Œ! ë¬´ìŠ¹ë¶€ì…ë‹ˆë‹¤!** ğŸ¤')
        } else {
          if (data.winner === playerMark) {
            // ìŠ¹ë¦¬í–ˆì„ ë•Œ: "XíŒ€ ìŠ¹ë¦¬. ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤."
            message = getStatusMessage(
              `ğŸ‰ **ê²Œì„ ì¢…ë£Œ! ${data.winner}íŒ€ ìŠ¹ë¦¬. ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!** ğŸ†`
            )
          } else {
            // íŒ¨ë°°í–ˆì„ ë•Œ: "OíŒ€ íŒ¨ë°°. íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤."
            message = getStatusMessage(
              `ğŸ˜­ **ê²Œì„ ì¢…ë£Œ! ${data.loser}íŒ€ íŒ¨ë°°. íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...** âš”ï¸`
            )
          }
        }

        statusDiv.innerHTML = message
      })
    </script>
  </body>
</html>
